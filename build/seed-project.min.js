/*! seed-project 2014-06-18 */
"use strict";function main(a){new HttpServer({GET:createServlet(StaticServlet),HEAD:createServlet(StaticServlet)}).start(Number(a[2])||DEFAULT_PORT)}function escapeHtml(a){return a.toString().replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;")}function createServlet(a){var b=new a;return b.handleRequest.bind(b)}function HttpServer(a){this.handlers=a,this.server=http.createServer(this.handleRequest_.bind(this))}function StaticServlet(){}var util=require("util"),http=require("http"),fs=require("fs"),url=require("url"),events=require("events"),DEFAULT_PORT=3e3;HttpServer.prototype.getServer=function(){return this.server},HttpServer.prototype.start=function(a){return this.port=a,this.server.listen(a),util.puts("Http Server running at http://localhost:"+a+"/"),this},HttpServer.prototype.parseUrl_=function(a){var b=url.parse(a);return b.pathname=url.resolve("/",b.pathname),url.parse(url.format(b),!0)},HttpServer.prototype.handleRequest_=function(a,b){var c=a.method+" "+a.url;a.headers["user-agent"]&&(c+=" "+a.headers["user-agent"]),util.puts(c),a.url=this.parseUrl_(a.url);var d=this.handlers[a.method];d?d.call(this,a,b):(b.writeHead(501),b.end())},StaticServlet.MimeMap={txt:"text/plain",html:"text/html",css:"text/css",xml:"application/xml",json:"application/json",js:"application/javascript",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml"},StaticServlet.prototype.handleRequest=function(a,b){var c=this,d=("./"+a.url.pathname).replace("//","/").replace(/%(..)/g,function(a,b){return String.fromCharCode(parseInt(b,16))}),e=d.split("/");return"."===e[e.length-1].charAt(0)?c.sendForbidden_(a,b,d):2===e.length&&""===e[1]?c.sendFile_(a,b,d+"app/index.html"):void fs.stat(d,function(e,f){return e?c.sendMissing_(a,b,d):f.isDirectory()?c.sendDirectory_(a,b,d):c.sendFile_(a,b,d)})},StaticServlet.prototype.sendError_=function(a,b,c){b.writeHead(500,{"Content-Type":"text/html"}),b.write("<!doctype html>\n"),b.write("<title>Internal Server Error</title>\n"),b.write("<h1>Internal Server Error</h1>"),b.write("<pre>"+escapeHtml(util.inspect(c))+"</pre>"),util.puts("500 Internal Server Error"),util.puts(util.inspect(c))},StaticServlet.prototype.sendMissing_=function(a,b,c){c=c.substring(1),b.writeHead(404,{"Content-Type":"text/html"}),b.write("<!doctype html>\n"),b.write("<title>404 Not Found</title>\n"),b.write("<h1>Not Found</h1>"),b.write("<p>The requested URL "+escapeHtml(c)+" was not found on this server.</p>"),b.end(),util.puts("404 Not Found: "+c)},StaticServlet.prototype.sendForbidden_=function(a,b,c){c=c.substring(1),b.writeHead(403,{"Content-Type":"text/html"}),b.write("<!doctype html>\n"),b.write("<title>403 Forbidden</title>\n"),b.write("<h1>Forbidden</h1>"),b.write("<p>You do not have permission to access "+escapeHtml(c)+" on this server.</p>"),b.end(),util.puts("403 Forbidden: "+c)},StaticServlet.prototype.sendRedirect_=function(a,b,c){b.writeHead(301,{"Content-Type":"text/html",Location:c}),b.write("<!doctype html>\n"),b.write("<title>301 Moved Permanently</title>\n"),b.write("<h1>Moved Permanently</h1>"),b.write('<p>The document has moved <a href="'+c+'">here</a>.</p>'),b.end(),util.puts("301 Moved Permanently: "+c)},StaticServlet.prototype.sendFile_=function(a,b,c){var d=this,e=fs.createReadStream(c);b.writeHead(200,{"Content-Type":StaticServlet.MimeMap[c.split(".").pop()]||"text/plain"}),"HEAD"===a.method?b.end():(e.on("data",b.write.bind(b)),e.on("close",function(){b.end()}),e.on("error",function(c){d.sendError_(a,b,c)}))},StaticServlet.prototype.sendDirectory_=function(a,b,c){var d=this;if(c.match(/[^\/]$/)){a.url.pathname+="/";var e=url.format(url.parse(url.format(a.url)));return d.sendRedirect_(a,b,e)}fs.readdir(c,function(e,f){if(e)return d.sendError_(a,b,e);if(!f.length)return d.writeDirectoryIndex_(a,b,c,[]);var g=f.length;f.forEach(function(e,h){fs.stat(c+"/"+e,function(i,j){return i?d.sendError_(a,b,i):(j.isDirectory()&&(f[h]=e+"/"),--g?void 0:d.writeDirectoryIndex_(a,b,c,f))})})})},StaticServlet.prototype.writeDirectoryIndex_=function(a,b,c,d){return c=c.substring(1),b.writeHead(200,{"Content-Type":"text/html"}),"HEAD"===a.method?void b.end():(b.write("<!doctype html>\n"),b.write("<title>"+escapeHtml(c)+"</title>\n"),b.write("<style>\n"),b.write("  ol { list-style-type: none; font-size: 1.2em; }\n"),b.write("</style>\n"),b.write("<h1>Directory: "+escapeHtml(c)+"</h1>"),b.write("<ol>"),d.forEach(function(a){"."!==a.charAt(0)&&b.write('<li><a href="'+escapeHtml(a)+'">'+escapeHtml(a)+"</a></li>")}),b.write("</ol>"),void b.end())},main(process.argv);